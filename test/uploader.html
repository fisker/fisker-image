<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>fisker image upload test</title>
  <style>
  img,
  canvas {
    max-width: 100%;
  }
  </style>
</head>
<body>
  <form enctype="multipart/form-data" action="./upload.php" method="post" id="js-form">
    <input type="file" name="file[]" id="uploader" accept="image/jpeg,image/png" capture="camera" multiple>
    <button type="submit">提交</button>
  </form>

  <div id="js-result"></div>
  <script src="../node_modules/es6-promise/dist/es6-promise.auto.min.js"></script>
  <script src="../node_modules/jquery/dist/jquery.min.js"></script>
  <script src="../src/fisker-image.js"></script>
  <script src="./upload-files.js"></script>

  <script>
  if (window.location.protocol === 'file:') {
    alert('this demo can\'t run on file: protocol')
  }

  var form = document.getElementById('js-form')
  var input = form.uploader
  var result = document.getElementById('js-result')

  function upload(orignalFiles) {
    if (!orignalFiles || !orignalFiles.length) {
      return
    }

    result.innerHTML = ''

    return uploadFiles(form.action, input.name, orignalFiles)
      .then(function(results) {
        result.innerHTML = results.map(function(result, index) {
          var orignalSize = orignalFiles[index].size
          var isImg = /^image\//.test(result.type)

          return [
            '<div>',
            '<h1>' + result.name + '</h1>',
            '<table><tbody>',
            '<tr><th>源文件</th><td>' + orignalSize + '</td></tr>',
            '<tr><th>压缩后</th><td>' + result.size + '</td></tr>',
            '<tr><th>压缩比</th><td>' + ((orignalSize - result.size) / orignalSize * 100).toFixed(2) + '%</td></tr>',
            '</tbody></table>',
            isImg ? '<img src="' + result.path + '" alt="' + result.name + '">' : '<a href="' + result.path + '">' + result.name + '</a>',
            '</div>',
          ].join('')
        }).join('<hr>')
      })
      .then(function() {
        form.reset()
      })
      .catch(function(e) {
        console.error(e)
      })
  }

  form.addEventListener('submit', function(e) {
    e.preventDefault()
    upload(input.files)
  }, false)

  input.addEventListener('change', function(e) {
    upload(input.files)
  }, false)
  </script>
</body>
</html>
